version: '3.7'

x-mysql-credentials: &mysql-credentials
  MYSQL_HOST: mysqldb
  MYSQL_DATABASE: ${DB_DATABASE}
  MYSQL_USER: ${DB_USERNAME}
  MYSQL_PASSWORD: ${DB_PASSWORD}

x-php-defaults: &php-defaults
  image: gsmainclusivetechlab/interop-test-platform/app:${CIRCLE_SHA1:-latest}
  build:
    context: src
  cap_add:
    - SYS_PTRACE
  security_opt:
    - apparmor:unconfined
  environment: &php-env-defaults
    <<: *mysql-credentials
    PHP_INI_TEMPLATE: ${PHP_INI_TEMPLATE}
  depends_on:
    - redis
    - mysqldb
  networks:
    - internal

networks:
  internal:
    driver: bridge

services:
  app:
    <<: *php-defaults
    environment:
      <<: *php-env-defaults
      CONTAINER_ROLE: app

  queue:
    <<: *php-defaults
    environment:
      <<: *php-env-defaults
      CONTAINER_ROLE: queue

  redis:
    image: redis:5
    environment:
      - REDIS_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
    networks:
      - internal
    volumes:
      - redisdata:/data

  mysqldb:
    image: gsmainclusivetechlab/interop-test-platform/mysqldb:${CIRCLE_SHA1:-latest}
    build:
      context: mysqldb
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      <<: *mysql-credentials
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost']
      timeout: 20s
      retries: 10
    networks:
      internal:
    volumes:
      - mysqldata:/var/lib/mysql

volumes:
  mysqldata:
  redisdata:
