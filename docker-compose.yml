version: '3.7'

x-php-defaults: &php-defaults
  image: gsmainclusivetechlab/interop-test-platform:${CIRCLE_SHA1:-latest}
  build:
    context: src
    args:
      PHP_INI_TEMPLATE: $PHP_INI_TEMPLATE
      APP_ENV: $APP_ENV
      HOST_UID: ${HOST_UID:-www-data:www-data}
      HTTPS_SSL_CERT: ${HTTPS_SSL_CERT:-selfsigned}
      PROJECT_DOMAIN: ${PROJECT_DOMAIN}
  cap_add:
    - SYS_PTRACE
  security_opt:
    - apparmor:unconfined
  env_file: service.env
  depends_on:
    - redis
    - mysqldb
  networks:
    - internal

networks:
  internal:
    driver: bridge

services:
  app:
    <<: *php-defaults
    environment:
      CONTAINER_ROLE: app
      PROJECT_DOMAIN: ${PROJECT_DOMAIN}
      HTTPS_SSL_CERT: ${HTTPS_SSL_CERT:-selfsigned}
    volumes:
      - ca_certs:/etc/nginx/ssl/default-certs
      - certbot_certs:/etc/nginx/ssl/letsencrypt
      - certbot_www:/var/www/certbot
      - storage:/var/www/html/storage/app
  queue:
    <<: *php-defaults
    volumes:
      - storage:/var/www/html/storage/app
    environment:
      CONTAINER_ROLE: queue

  redis:
    image: redis:5
    environment:
      - REDIS_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
    networks:
      - internal
    volumes:
      - redisdata:/data

  mysqldb:
    image: gsmainclusivetechlab/interop-test-platform/mysqldb:${CIRCLE_SHA1:-latest}
    build:
      context: mysqldb
    env_file: service.env
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost']
      timeout: 20s
      retries: 10
    networks:
      internal:
    volumes:
      - mysqldata:/var/lib/mysql
  certbot:
    env_file: ${ENV_FILE:-.env}
    environment:
      PROJECT_DOMAIN: ${PROJECT_DOMAIN}
    container_name: certbot
    image: certbot/certbot
    restart: unless-stopped #+++
    volumes:
      - certbot_certs:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    entrypoint:
      "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait
      $${!}; done;'"
volumes:
  mysqldata:
  redisdata:
  ca_certs:
  certbot_certs:
  certbot_www:
  storage:
