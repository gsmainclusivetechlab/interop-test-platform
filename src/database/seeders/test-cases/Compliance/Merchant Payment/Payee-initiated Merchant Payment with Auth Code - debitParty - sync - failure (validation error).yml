name: Payee/Merchant-Initiated Merchant Payment with Auth Code - debitParty - sync - failure (validation error)
slug: payee-initiated-merchant-payment-with-auth-code-debitparty-sync-failure-validation-error
use_case: Merchant Payment
behavior: negative
description: |
  The Service Provider requests a Payee-initiated merchant payment through the Mobile Money API sending the customer's pre-authorised code and the Mobile Money Provider handles the request and responds with an synchronous response. The payment request fails and an error object is sent back to the service provider indicating a failure due to validation error (invalid code).
precondition: |
  - Mobile Money Operator has GSMA Mobile Money API Implemented.
  - Required Parameters for Execution:
    - Amount should be the value `31.00`.
  - Define the envrionment variables to customise this test case:
    - `X_CLIENT_ID_MERCHANT`, default value is `MERCHANT67890`
    - `CURRENCY`, default value is `USD`
    - `DEBIT_PARTY_KEY`, default value is `msisdn`
    - `DEBIT_PARTY_VALUE`, default value is `+33555123456`
components:
  -
    name: 'Service Provider'
    slug: sp
  -
    name: 'Mobile Money API Provider'
    slug: mmap
test_steps:
  -
    path: '/transactions/type/{transactionType}'
    pattern: ^transactions/type/merchantpay$
    method: POST
    source: sp
    target: mmap
    api_spec: 'MM v1.2'
    trigger:
      amount: '31.00'
    test_request_scripts:
      -
        name: 'Header has the X-Client-Id'
        rules:
          headers.X-Client-Id: required
      -
        name: 'Amount is specified correctly'
        rules:
          body.amount: 'regex:/^31([.][0-9]{0,4})?$/'
    test_response_scripts:
      -
        name: 'Error category is valid'
        rules:
          body.errorCategory: 'required|in:validation'
      -
        name: 'Error code is valid'
        rules:
          body.errorCode: 'required|in:genericError'
      -
        name: 'Error status is correct'
        rules:
          status: 'required|in:400'
    request:
      method: POST
      uri: /transactions/type/merchantpay
      headers:
        Accept: application/json
        X-Date: '{{ new_date_iso8601() }}'
        X-Client-Id: '{{ env.X_CLIENT_ID_MERCHANT|default("MERCHANT67890") }}'
        Content-Type: application/json
        X-CorrelationID: '{{ uuidv4() }}'
      body:
        amount: '31.00'
        currency: '{{ env.CURRENCY|default("USD")}}'
        debitParty:
          -
            key: '{{ env.DEBIT_PARTY_KEY|default("msisdn")}}'
            value: '{{ env.DEBIT_PARTY_VALUE|default("+33555123456")}}'
        creditParty:
          -
            key: '{{ env.CREDIT_PARTY_KEY|default("msisdn")}}'
            value: '{{ env.CREDIT_PARTY_VALUE|default("+33555789123")}}'
        oneTimeCode: '{{ env.AUTH_CODE|default("AC12345")}}'
    response:
      status: 400
      headers:
        X-Date: '{{ new_date_iso8601() }}'
        Content-Type: application/json
      body:
        errorCode: genericError
        errorCategory: validation
